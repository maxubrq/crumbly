name: Build & Publish Crumbly

on:
  push:
    branches: [ main ]
    tags:     [ 'v*' ]        # v1.2.3 â†’ full release & store publish
  workflow_dispatch:          # manual trigger

permissions:
  contents: write             # create release
  id-token: write             # required by web-store signers

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: â¬‡ï¸  Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0        # so `git describe` works on tag

      - name: ğŸ—ï¸ Setup PNPM + Node
        uses: pnpm/action-setup@v3
        with:
          node-version: 20
          pnpm-version: 9

      - name: ğŸ“¦ Install deps
        run: pnpm install --frozen-lockfile

      - name: âœ… Lint + Unit tests
        run: pnpm test -- --run

      - name: ğŸ—ï¸ Build extension
        run: pnpm build          # produces dist/ via @crxjs/vite-plugin

      # â”€â”€â”€ Chromium bundle (ZIP + CRX) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¦ Pack CRX
        id: crx
        uses: LittleHelicase/crx3-action@v2
        with:
          src: dist
          crx-key: |
            -----BEGIN PRIVATE KEY-----
            # paste a *development* RSA key or let the action generate
            -----END PRIVATE KEY-----

      - name: ğŸ“¦ Zip Chromium bundle
        run: cd dist && zip -r ../crumbly-chrome-zip.zip .

      # â”€â”€â”€ Firefox bundle (unsigned XPI) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¦ Build XPI
        run: |
          pnpm dlx web-ext build \
            --source-dir=dist \
            --artifacts-dir=web-ext-artifacts \
            --ignore-files '/**/*.map'
          mv web-ext-artifacts/*.xpi crumbly-firefox.xpi

      # â”€â”€â”€ Upload artifacts on every push â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: crumbly-builds
          path: |
            crumbly-chrome-zip.zip
            ${{ steps.crx.outputs.crx-path }}
            crumbly-firefox.xpi
          if-no-files-found: error

      # â”€â”€â”€ Publish on version tags only â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: â© Skip publish if not tag
        if: ${{ github.ref_type != 'tag' }}
        run: echo "Not a tag, finished build pipeline."

      # 1ï¸âƒ£  Create GitHub Release
      - name: ğŸ“‘ Create GitHub Release
        if:   ${{ github.ref_type == 'tag' }}
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}
          files: |
            crumbly-chrome-zip.zip
            ${{ steps.crx.outputs.crx-path }}
            crumbly-firefox.xpi

      # 2ï¸âƒ£  Publish to Chrome Web Store
      - name: ğŸš€ Publish to Chrome Web Store
        if:   ${{ github.ref_type == 'tag' }}
        uses: Klemensas/chrome-extension-upload-action@v2
        with:
          extension-id:     ${{ secrets.CHROME_EXTENSION_ID }}
          client-id:        ${{ secrets.CHROME_CLIENT_ID }}
          client-secret:    ${{ secrets.CHROME_CLIENT_SECRET }}
          refresh-token:    ${{ secrets.CHROME_REFRESH_TOKEN }}
          zip-path:         crumbly-chrome-zip.zip
          publish:          true

      # 3ï¸âƒ£  Sign & Publish to Firefox Add-ons (AMO)
      - name: ğŸš€ Sign & Publish to AMO
        if:   ${{ github.ref_type == 'tag' }}
        uses: kewisch/action-web-ext@v1
        with:
          cmd: sign
          source: dist
          apiKey:    ${{ secrets.AMO_JWT_ISSUER }}
          apiSecret: ${{ secrets.AMO_JWT_SECRET }}
          channel:   listed
